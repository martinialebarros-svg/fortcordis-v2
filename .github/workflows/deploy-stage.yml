# Deploy para ambiente de stage (www.stage.fortcordis.com.br)
# Dispara ao dar push na branch stage (ex.: git push origin feature/laudos-pdf-imagens:stage)
name: Deploy to Stage (VPS)

on:
  push:
    branches:
      - stage

jobs:
  deploy-stage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Stage (VPS)
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -euo pipefail
            STAGE_DIR="/var/www/fortcordis-stage"
            restart_service() {
              svc="$1"
              echo "Restarting ${svc}..."
              if sudo -n systemctl restart "$svc" 2>/dev/null; then
                :
              else
                pid="$(systemctl show "$svc" -p MainPID --value 2>/dev/null || true)"
                if [ -n "$pid" ] && [ "$pid" != "0" ]; then
                  kill -TERM "$pid" || true
                  sleep 3
                fi
              fi
              if ! systemctl is-active --quiet "$svc"; then
                echo "Service ${svc} is not active after deploy."
                exit 1
              fi
            }
            if [ ! -d "$STAGE_DIR/.git" ]; then
              echo "‚ùå $STAGE_DIR n√£o est√° clonado. Na VPS rode: sudo mkdir -p $STAGE_DIR && sudo chown $USER $STAGE_DIR && git clone <url-do-repo> $STAGE_DIR"
              exit 1
            fi
            cd $STAGE_DIR
            echo "üì¶ Backup stage..."
            tar -czf backup_stage_$(date +%Y%m%d_%H%M%S).tar.gz backend frontend 2>/dev/null || true
            
            echo "üíæ Preservando dados (frases JSON)..."
            if [ -d "backend/data" ]; then
              cp -r backend/data /tmp/fortcordis_data_backup
            fi
            
            echo "‚¨áÔ∏è  Atualizando c√≥digo (branch stage)..."
            git fetch origin
            git reset --hard origin/stage
            
            echo "üìÇ Restaurando dados preservados..."
            if [ -d "/tmp/fortcordis_data_backup" ]; then
              cp -r /tmp/fortcordis_data_backup/* backend/data/ 2>/dev/null || true
              rm -rf /tmp/fortcordis_data_backup
            fi
            
            echo "üêç Deploy Backend (stage)..."
            cd backend
            python3 -m venv venv 2>/dev/null || true
            source venv/bin/activate
            pip install -r requirements.txt
            if [ -f .env ]; then
              set -a
              source .env
              set +a
            fi
            
            echo "üîß Verificando/Criando tabelas do banco..."
            python3 setup_database.py || echo "‚ö†Ô∏è  Erro no setup do banco - verificar manualmente"
            
            cd ..
            restart_service fortcordis-stage-backend
            
            echo "‚öõÔ∏è  Deploy Frontend (stage)..."
            cd frontend
            npm install
            API_BACKEND_URL=http://127.0.0.1:8001 npm run build
            cd ..
            restart_service fortcordis-stage-frontend
            
            echo "‚úÖ Deploy stage conclu√≠do!"
          EOF
